<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frida Sofia | Gesti√≥n & Pagos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,600;1,400&family=Montserrat:wght@100;300;600&display=swap" rel="stylesheet">

    <style type="text/tailwindcss">
        @layer base {
            body { @apply bg-white text-[#1a1a1a] antialiased overflow-x-hidden; font-family: 'Montserrat', sans-serif; }
            .font-serif { font-family: 'Cormorant Garamond', serif; }
        }
        .btn-black { @apply bg-black text-white px-8 py-4 text-[10px] tracking-[0.3em] uppercase font-black transition-all duration-300 hover:bg-zinc-800 disabled:opacity-50 flex items-center justify-center gap-2; }
        .btn-outline { @apply border border-zinc-200 text-black px-8 py-4 text-[10px] tracking-[0.3em] uppercase font-black transition-all duration-300 hover:bg-zinc-50 flex items-center justify-center gap-2; }
        .input-line { @apply border-b border-zinc-200 py-3 w-full text-sm outline-none focus:border-black transition-all bg-transparent rounded-none; }
        .loader { border-top-color: #000; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // TU CONFIGURACI√ìN REAL
        const firebaseConfig = {
            apiKey: "AIzaSyBOE6fMDtoCsJ92oVdY_ZqBuNDW-idyUqc",
            authDomain: "frida-s-6a626.firebaseapp.com",
            projectId: "frida-s-6a626",
            storageBucket: "frida-s-6a626.firebasestorage.app",
            messagingSenderId: "951753942306",
            appId: "1:951753942306:web:823632f6855f4a07e1f17b",
            measurementId: "G-RJFR93LNCL"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const CATEGORIES = ["Todos", "Tejidos", "Manualidades", "Ropa Nueva", "Ropa Usada"];
        const ADMIN_PIN = "2024";
        const STRIPE_LINK = "https://buy.stripe.com/00weVcchf6UKfGfdMx18c04";
        const WHATSAPP_NUM = "5215648515663"; 

        function App() {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [view, setView] = useState('home'); 
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(true);
            const [isProcessing, setIsProcessing] = useState(false);
            const [statusMsg, setStatusMsg] = useState(null);
            
            const [loginPin, setLoginPin] = useState('');
            const [activeCategory, setActiveCategory] = useState('Todos');
            const [showModal, setShowModal] = useState(false);
            const [formData, setFormData] = useState({ name: '', price: '', category: 'Tejidos', image: '', stock: 1, description: '' });

            useEffect(() => {
                auth.signInAnonymously().catch(e => console.error("Error Auth:", e));
                const unsub = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (localStorage.getItem('fridaAdmin') === 'true') setIsAdmin(true);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                // Ruta simplificada para asegurar que guarde correctamente
                const unsub = db.collection('products').orderBy('createdAt', 'desc')
                    .onSnapshot((snap) => {
                        const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setProducts(data);
                        setLoading(false);
                    }, (err) => {
                        console.error("Error Firestore:", err);
                        setLoading(false);
                    });
                return () => unsub();
            }, [user]);

            const saveProduct = async (e) => {
                e.preventDefault();
                if (isProcessing) return;
                setIsProcessing(true);
                try {
                    await db.collection('products').add({
                        ...formData,
                        price: Number(formData.price),
                        stock: Number(formData.stock),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setShowModal(false);
                    setFormData({ name: '', price: '', category: 'Tejidos', image: '', stock: 1, description: '' });
                    setStatusMsg("Guardado con √©xito");
                    setTimeout(() => setStatusMsg(null), 2000);
                } catch (err) { alert("Error al guardar"); }
                finally { setIsProcessing(false); }
            };

            const deleteProduct = async (id) => {
                if (!confirm("¬øEliminar este producto?")) return;
                try {
                    await db.collection('products').doc(id).delete();
                    setStatusMsg("Eliminado");
                    setTimeout(() => setStatusMsg(null), 2000);
                } catch (err) { alert("No se pudo eliminar"); }
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600;
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        setFormData(prev => ({ ...prev, image: canvas.toDataURL('image/jpeg', 0.6) }));
                    };
                };
                reader.readAsDataURL(file);
            };

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="w-8 h-8 loader border-2 border-zinc-100 rounded-full"></div></div>;

            return (
                <div className="min-h-screen flex flex-col">
                    <nav className="fixed top-0 w-full z-50 bg-white/90 backdrop-blur-md border-b border-zinc-50 px-6 h-20 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={() => isAdmin ? setView('admin') : setView('login')} className="opacity-20 hover:opacity-100 p-2">‚öôÔ∏è</button>
                            <h1 onClick={() => setView('home')} className="font-serif text-3xl italic cursor-pointer">Frida Sofia</h1>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setView('shop')} className="text-[10px] uppercase font-black tracking-widest">Tienda</button>
                            <button onClick={() => setView('cart')} className="relative">
                                üõí {cart.length > 0 && <span className="absolute -top-2 -right-2 bg-black text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center">{cart.length}</span>}
                            </button>
                        </div>
                    </nav>

                    {statusMsg && <div className="fixed top-24 right-6 z-[60] bg-black text-white text-[10px] px-6 py-3">{statusMsg}</div>}

                    <main className="pt-20 flex-grow">
                        {view === 'home' && (
                            <section className="h-[85vh] flex flex-col items-center justify-center text-center px-6 bg-zinc-50">
                                <h2 className="text-7xl font-serif italic mb-8">Colecci√≥n Frida</h2>
                                <button onClick={() => setView('shop')} className="btn-black">Explorar Cat√°logo</button>
                            </section>
                        )}

                        {view === 'shop' && (
                            <div className="max-w-7xl mx-auto px-6 py-16">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-8">
                                    {products.map(p => (
                                        <div key={p.id} className="group" onClick={() => {setCart([...cart, p]); setStatusMsg("Agregado"); setTimeout(()=>setStatusMsg(null),1000)}}>
                                            <img src={p.image} className="aspect-[3/4] object-cover mb-4" />
                                            <h4 className="font-serif text-xl italic">{p.name}</h4>
                                            <p className="font-bold">${p.price}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'admin' && isAdmin && (
                            <div className="max-w-7xl mx-auto px-6 py-16">
                                <div className="flex justify-between mb-12">
                                    <h2 className="text-4xl font-serif italic">Inventario</h2>
                                    <button onClick={() => setShowModal(true)} className="btn-black">Nuevo Producto</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
                                    {products.map(p => (
                                        <div key={p.id} className="border p-4">
                                            <img src={p.image} className="aspect-[3/4] object-cover mb-4" />
                                            <p className="font-serif italic">{p.name}</p>
                                            <button onClick={() => deleteProduct(p.id)} className="text-red-500 text-[10px] font-black mt-2">ELIMINAR</button>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => {setIsAdmin(false); localStorage.removeItem('fridaAdmin'); setView('home')}} className="mt-10 opacity-50">Cerrar Sesi√≥n</button>
                            </div>
                        )}

                        {view === 'login' && (
                            <div className="max-w-xs mx-auto py-32">
                                <form onSubmit={(e) => { e.preventDefault(); if(loginPin === ADMIN_PIN){ setIsAdmin(true); localStorage.setItem('fridaAdmin','true'); setView('admin'); } else { alert("Error"); } }} className="space-y-6">
                                    <input type="password" placeholder="PIN" className="input-line text-center" onChange={e=>setLoginPin(e.target.value)} />
                                    <button className="btn-black w-full">Entrar</button>
                                </form>
                            </div>
                        )}
                    </main>

                    {showModal && (
                        <div className="fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-6">
                            <div className="bg-white p-10 max-w-lg w-full">
                                <button onClick={()=>setShowModal(false)} className="float-right">X</button>
                                <h3 className="text-2xl font-serif italic mb-6">Nuevo Producto</h3>
                                <form onSubmit={saveProduct} className="space-y-4">
                                    <input type="file" onChange={handleImageUpload} className="text-xs" required />
                                    <input placeholder="Nombre" className="input-line" onChange={e=>setFormData({...formData, name: e.target.value})} required />
                                    <input type="number" placeholder="Precio" className="input-line" onChange={e=>setFormData({...formData, price: e.target.value})} required />
                                    <button className="btn-black w-full" disabled={isProcessing}>{isProcessing ? 'Guardando...' : 'Publicar'}</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>